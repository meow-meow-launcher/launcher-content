var H=Object.defineProperty;var L=(t,n,s)=>n in t?H(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var A=(t,n,s)=>L(t,typeof n!="symbol"?n+"":n,s);import{x as T,l as B,G as V,Y as Z,r as j,g as N,W as U,n as Q,H as q,Z as x,f as R,w as X,j as ee,P as te,z as re,i as W,I as ae,o as ne}from"./BH4CL5cc.js";import{d as se}from"./BkJeMoP0.js";import{f as ie,a as oe,b as $,c as le}from"./BhmYCg8b.js";import{t as G}from"./O0opt6N1.js";import"./4qzInpf6.js";function ue(t){return t.validate&&t.__isYupSchema__}function ce(t){return t.inner!==void 0}function de(t){return"schema"in t&&typeof t.coercer=="function"&&typeof t.validator=="function"&&typeof t.refiner=="function"}function fe(t){return t.validateAsync!==void 0&&t.id!==void 0}function me(t){return t.isJoi===!0}function pe(t){return"~standard"in t}async function ye(t,n){var r;const s=await n["~standard"].validate(t);return s.issues?{errors:((r=s.issues)==null?void 0:r.map(o=>{var u;return{name:((u=o.path)==null?void 0:u.map(m=>typeof m=="object"?m.key:m).join("."))||"",message:o.message}}))||[],result:null}:{errors:null,result:s.value}}async function ve(t,n){try{return{errors:null,result:await n.validate(t,{abortEarly:!1})}}catch(s){if(ce(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function he(t,n){const[s,r]=n.validate(t);return s?{errors:s.failures().map(u=>({message:u.message,name:u.path.join(".")})),result:null}:{errors:null,result:r}}async function we(t,n){try{return{errors:null,result:await n.validateAsync(t,{abortEarly:!1})}}catch(s){if(me(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function be(t,n){if(pe(n))return ye(t,n);if(fe(n))return we(t,n);if(ue(n))return ve(t,n);if(de(n))return he(t,n);throw new Error("Form validation failed: Unsupported form schema")}class F extends Error{constructor(s,r,o){super("Form validation exception");A(this,"formId");A(this,"errors");A(this,"children");this.formId=s,this.errors=r,this.children=o,Object.setPrototypeOf(this,F.prototype)}}const ge={base:""},Oe={__name:"Form",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:Boolean,required:!1,default:!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(t,{expose:n,emit:s}){const r=t,o=s,u=T(),m=B(()=>{var e;return G({extend:G(ge),...((e=u.ui)==null?void 0:e.form)||{}})}),p=r.id??V(),C=se(`form-${p}`),y=r.attach&&Z($,void 0);q($,C);const Y=j(new Map);N(async()=>{C.on(async e=>{var a;e.type==="attach"?Y.value.set(e.formId,{validate:e.validate}):e.type==="detach"?Y.value.delete(e.formId):(a=r.validateOn)!=null&&a.includes(e.type)&&!f.value&&(e.type!=="input"?await v({name:e.name,silent:!0,nested:!1}):(e.eager||k.has(e.name))&&await v({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&k.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&J.add(e.name),(e.type==="change"||e.type==="input")&&_.add(e.name)})}),U(()=>{C.reset()}),N(async()=>{y&&(await Q(),y.emit({type:"attach",validate:v,formId:p}))}),U(()=>{y&&y.emit({type:"detach",formId:p})});const i=j([]);q("form-errors",i);const O=j({});q(le,O);const _=new Set,J=new Set,k=new Set;function D(e){return e.map(a=>{var l;return{...a,id:a!=null&&a.name?(l=O.value[a.name])==null?void 0:l.id:void 0}})}const K=j(null);async function P(){let e=r.validate?await r.validate(r.state)??[]:[];if(r.schema){const{errors:a,result:l}=await be(r.state,r.schema);a?e=e.concat(a):K.value=l}return D(e)}async function v(e={silent:!1,nested:!0,transform:!1}){const a=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!a&&e.nested?Array.from(Y.value.values()).map(({validate:d})=>d(e).then(()=>{}).catch(h=>{if(!(h instanceof F))throw h;return h})):[];if(a){const d=i.value.filter(w=>!a.some(b=>{var S,E,I;const g=(E=(S=O.value)==null?void 0:S[b])==null?void 0:E.pattern;return b===w.name||g&&((I=w.name)==null?void 0:I.match(g))})),h=(await P()).filter(w=>a.some(b=>{var S,E,I;const g=(E=(S=O.value)==null?void 0:S[b])==null?void 0:E.pattern;return b===w.name||g&&((I=w.name)==null?void 0:I.match(g))}));i.value=d.concat(h)}else i.value=await P();const c=(await Promise.all(l)).filter(d=>d!==void 0);if(i.value.length+c.length>0){if(e.silent)return!1;throw new F(p,i.value,c)}return e.transform&&Object.assign(r.state,K.value),r.state}const f=j(!1);q(ie,x(f));async function z(e){var l;f.value=r.loadingAuto&&!0;const a=e;try{a.data=await v({nested:!0,transform:r.transform}),await((l=r.onSubmit)==null?void 0:l.call(r,a)),_.clear()}catch(c){if(!(c instanceof F))throw c;const d={...a,errors:c.errors,children:c.children};o("error",d)}finally{f.value=!1}}const M=B(()=>r.disabled||f.value);return q(oe,B(()=>({disabled:M.value,validateOnInputDelay:r.validateOnInputDelay}))),n({validate:v,errors:i,setErrors(e,a){a?i.value=i.value.filter(l=>l.name!==a).concat(D(e)):i.value=D(e)},async submit(){await z(new Event("submit"))},getErrors(e){return e?i.value.filter(a=>a.name===e):i.value},clear(e){e?i.value=i.value.filter(a=>a.name!==e):i.value=[]},disabled:M,loading:f,dirty:B(()=>!!_.size),dirtyFields:x(_),blurredFields:x(k),touchedFields:x(J)}),(e,a)=>(ne(),R(ae(W(y)?"div":"form"),{id:W(p),class:re(m.value({class:r.class})),onSubmit:te(z,["prevent"])},{default:X(()=>[ee(e.$slots,"default",{errors:i.value})]),_:3},40,["id","class"]))}};export{Oe as default};
